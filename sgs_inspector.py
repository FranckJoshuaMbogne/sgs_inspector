# -*- coding: utf-8 -*-
"""sgs_inspector

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZrqSCd5Qa48aLF_e_SfKfeeUg-TX4mFx
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
import random

# Configuration
st.set_page_config(page_title="SGS Inspector Dashboard", layout="wide")

st.title("ğŸ“Š Tableau de bord - Inspections SGS (DonnÃ©es simulÃ©es)")
st.markdown("Ce tableau de bord prÃ©sente une visualisation fictive de l'activitÃ© d'inspection. Les donnÃ©es sont simulÃ©es Ã  des fins de dÃ©monstration.")

# --- GÃ©nÃ©ration de donnÃ©es simulÃ©es ---
@st.cache_data
def generate_data():
    random.seed(42)
    clients = ["Total", "Brasseries", "Sodecoton", "Sonara", "Dangote", "PMUC"]
    regions = ["Littoral", "Centre", "Nord", "Ouest", "Sud-Ouest"]
    secteurs = ["Agroalimentaire", "PÃ©trole", "Transport", "Pharma", "Construction"]

    data = []
    for _ in range(500):
        date = datetime.now() - timedelta(days=random.randint(1, 365))
        client = random.choice(clients)
        region = random.choice(regions)
        secteur = random.choice(secteurs)
        conformite = random.choices(["Conforme", "Non conforme"], weights=[0.8, 0.2])[0]
        duree = round(random.uniform(1, 5), 2)
        data.append([date, client, region, secteur, conformite, duree])

    df = pd.DataFrame(data, columns=["Date", "Client", "RÃ©gion", "Secteur", "Statut conformitÃ©", "DurÃ©e (jours)"])
    df["Mois"] = df["Date"].dt.to_period("M").astype(str)
    return df

df = generate_data()

# --- Filtres dynamiques ---
with st.sidebar:
    st.header("ğŸ”˜ Filtres dynamiques")
    use_filters = st.checkbox("Activer les filtres")

    if use_filters:
        selected_regions = st.multiselect("Choisir une ou plusieurs rÃ©gions", df["RÃ©gion"].unique())
        selected_secteurs = st.multiselect("Choisir les secteurs", df["Secteur"].unique())
        selected_statuts = st.multiselect("Statut de conformitÃ©", df["Statut conformitÃ©"].unique())

        apply_filters = st.button("âœ… Appliquer les filtres")
    else:
        apply_filters = False

# --- Application conditionnelle des filtres ---
if use_filters and apply_filters:
    df_filtered = df.copy()

    if selected_regions:
        df_filtered = df_filtered[df_filtered["RÃ©gion"].isin(selected_regions)]
    if selected_secteurs:
        df_filtered = df_filtered[df_filtered["Secteur"].isin(selected_secteurs)]
    if selected_statuts:
        df_filtered = df_filtered[df_filtered["Statut conformitÃ©"].isin(selected_statuts)]

    st.success(f"ğŸ¯ Filtres appliquÃ©s sur {len(df_filtered)} inspections")
else:
    df_filtered = df.copy()

# --- Affichage si donnÃ©es disponibles ---
if len(df_filtered) == 0:
    st.warning("Aucune donnÃ©e ne correspond aux filtres sÃ©lectionnÃ©s.")
else:
    # --- KPI ---
    col1, col2, col3 = st.columns(3)
    col1.metric("ğŸ“¦ Nombre d'inspections", len(df_filtered))
    conform_rate = df_filtered["Statut conformitÃ©"].value_counts(normalize=True).get("Conforme", 0)
    col2.metric("âœ… Taux de conformitÃ©", f"{conform_rate*100:.1f}%")
    col3.metric("â±ï¸ DurÃ©e moyenne (jours)", f"{df_filtered['DurÃ©e (jours)'].mean():.2f}")

    # --- Graphiques ---
    st.subheader("ğŸ“ˆ Ã‰volution mensuelle des inspections")
    fig1 = px.histogram(df_filtered, x="Mois", color="Statut conformitÃ©", barmode="group")
    st.plotly_chart(fig1, use_container_width=True)

    st.subheader("ğŸ“ RÃ©partition par rÃ©gion")
    fig2 = px.pie(df_filtered, names="RÃ©gion", title="RÃ©partition par rÃ©gion")
    st.plotly_chart(fig2, use_container_width=True)

    st.subheader("ğŸ” RÃ©partition par secteur")
    fig3 = px.bar(
    secteur_counts,
    x="Secteur", y="Nombre",
    title="Nombre d'inspections par secteur",
    labels={"Secteur": "Secteur", "Nombre": "Nombre"}
)
    st.plotly_chart(fig3, use_container_width=True)

    # --- Tableau brut ---
    with st.expander("ğŸ“„ Voir les donnÃ©es sources"):
        st.dataframe(df_filtered)

# --- Footer ---
st.markdown("---")
st.markdown("ğŸ”§ DÃ©mo rÃ©alisÃ©e dans le cadre d'une candidature spontanÃ©e chez **SGS Cameroun**. DonnÃ©es simulÃ©es.")